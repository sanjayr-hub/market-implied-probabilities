name: Polymarket → Google Sheets (latest)

on:
  schedule:
    - cron: "0 */3 * * *"   # every 3 hours
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run snapshot fetch
        run: |
          mkdir -p data
          python polymarket_snapshot.py markets.yaml data/polymarket_snapshots.csv data/polymarket_latest.csv

      - name: Verify latest CSV exists
        id: latest_csv_check
        run: |
          if [ ! -f data/polymarket_latest.csv ]; then
            echo "No latest CSV found — skipping Sheets update."
            echo "has_latest=false" >> $GITHUB_OUTPUT
          else
            echo "has_latest=true" >> $GITHUB_OUTPUT
          fi

      - name: Push latest CSV to Google Sheets (snapshots tab)
        if: steps.latest_csv_check.outputs.has_latest == 'true'
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          SNAPSHOTS_TAB: ${{ secrets.GOOGLE_SHEET_TAB }}
        run: |
          set -e
          success=0
          for i in 1 2 3 4 5; do
            echo "Push latest (replace) attempt $i..."
            if python tools/push_csv_to_gsheet.py \
              --csv data/polymarket_latest.csv \
              --sheet_id "$SHEET_ID" \
              --tab "$SNAPSHOTS_TAB" \
              --mode replace; then
              success=1
              break
            fi
            sleep $((i*i*10))
          done
          if [ "$success" -ne 1 ]; then
            echo "Failed to push latest after retries."
            exit 1
          fi

      - name: Append to history tab (snapshots_history)
        if: steps.latest_csv_check.outputs.has_latest == 'true'
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          HISTORY_TAB: snapshots_history
        run: |
          set -e
          success=0
          for i in 1 2 3 4 5; do
            echo "Append history attempt $i..."
            if python tools/push_csv_to_gsheet.py \
              --csv data/polymarket_latest.csv \
              --sheet_id "$SHEET_ID" \
              --tab "$HISTORY_TAB" \
              --mode append; then
              success=1
              break
            fi
            sleep $((i*i*10))
          done
          if [ "$success" -ne 1 ]; then
            echo "Failed to append history after retries."
            exit 1
          fi
